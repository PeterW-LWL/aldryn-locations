/*!
 * @author      Angelo Dini - github.com/finalangel/classjs-plugins
 * @copyright   Distributed under the BSD License.
 * @version     3.1.0
 */
var Cl=window.Cl||{};!function(o){"use strict";Cl.Locations=new Class({options:{edit_mode:!1,mapType:"",mapTypeControlOptions:google.maps.MapTypeControlStyle.DROPDOWN_MENU,markers:[],markerAnimation:google.maps.Animation.DROP,routePlanner:!1,settings:{},zoom:12,zoomControlOptions:google.maps.ZoomControlStyle.SMALL,cls:{mapContainer:".aldryn-locations-container",formContainer:".aldryn-locations-form",formOutput:".aldryn-locations-form-output"}},initialize:function(t,n){this.container=o(t),this.options=o.extend(!0,{},this.options,n),this.settings=this.options.settings,this.markers=[],this.bounds=new google.maps.LatLngBounds,this.form=this.container.find(this.options.cls.formContainer),this.mapTypes={hybrid:google.maps.MapTypeId.HYBRID,roadmap:google.maps.MapTypeId.ROADMAP,satellite:google.maps.MapTypeId.SATELLITE,terrain:google.maps.MapTypeId.TERRAIN},this._setup()},_setup:function(){this.settings.mapTypeId=this.mapTypes[this.options.mapType],this.settings.zoomControlOptions={style:this.options.zoomControlOptions},this.settings.mapTypeControlOptions={style:this.options.mapTypeControlOptions},this.mapContainer=this.container.find(this.options.cls.mapContainer)[0],this.map=new google.maps.Map(this.mapContainer,this.settings),this.addMarkers(this.options.markers),this.addLayers(this.options.layerSources),this._routePlanner()},addMarkers:function(o){function t(o){var t=new google.maps.Geocoder;t.geocode({address:o.address},function(t,e){e===google.maps.GeocoderStatus.OK&&(o.latlng=t[0].geometry.location,n.addMarker(o))})}for(var n=this,e=0;e<o.length;e++){var i=o[e];null===i.latlng?t(i):(i.latlng=new google.maps.LatLng(i.latlng),this.addMarker(i))}},addLayers:function(o){if(o&&o.length){var t=this;o.forEach(function(o){new google.maps.KmlLayer(o,{suppressInfoWindows:!0,preserveViewport:!1,map:t.map})})}},addMarker:function(o){var t=this;if(o=new google.maps.Marker({map:this.map,admin:o.admin,position:o.latlng,title:o.title,content:o.content}),o.content){var n=new google.maps.InfoWindow({disableAutoPan:!0,content:o.content});google.maps.event.addListener(o,"click",function(){n.open(t.map,o),o.setAnimation(google.maps.Animation.BOUNCE),setTimeout(function(){o.setAnimation(null)},750)}),setTimeout(function(){n.open(t.map,o)},500)}this.options.edit&&window.CMS&&google.maps.event.addListener(o,"dblclick",function(){var t=new CMS.Modal;t.open({url:o.admin})}),this.markers.push(o),this.bounds.extend(o.position),this.map.fitBounds(this.bounds),this.map.panBy(0,-50);var e=google.maps.event.addListener(t.map,"idle",function(){t.map.getZoom()>t.options.zoom&&t.map.setZoom(t.options.zoom),google.maps.event.removeListener(e)})},_routePlanner:function(){function t(){var o=n.form.find('input[type="text"]').val();n.map.getStreetView().setVisible(!1);var t={origin:o,destination:i,travelMode:google.maps.TravelMode[e.toUpperCase()]};a.route(t,function(o,t){t===google.maps.DirectionsStatus.OK?(r.setMap(n.map),r.setDirections(o),n.form.find(".form-group").removeClass("has-error")):n.form.find(".form-group").addClass("has-error")})}var n=this,e="",i=this.form.find('input[type="hidden"]').val(),s=this.container.find("span[data-type]"),a=new google.maps.DirectionsService,r=new google.maps.DirectionsRenderer;r.setMap(this.map),r.setPanel(this.container.find(this.options.cls.formOutput)[0]),s.on("click",function(){s.removeClass("active"),o(this).addClass("active"),e=o(this).data("type")}).eq(0).trigger("click"),this.form.on("submit",function(o){o.preventDefault(),t()})}})}(jQuery);
